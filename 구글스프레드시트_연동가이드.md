# 🔗 구글 스프레드시트 자동 연동 완벽 가이드

## 📋 **1단계: 구글 스프레드시트 생성**

### 1-1. 새 스프레드시트 만들기
1. **구글 스프레드시트 접속**: https://sheets.google.com
2. **"빈 스프레드시트"** 클릭하여 새 파일 생성
3. **제목 변경**: "실버케어 마케팅 상담신청"으로 변경

### 1-2. 헤더 설정
첫 번째 행에 다음 헤더를 입력하세요:

| A1 | B1 | C1 | D1 | E1 | F1 |
|----|----|----|----|----|----|
| **ID** | **이름** | **전화번호** | **회사명** | **메시지** | **신청일시** |

---

## ⚙️ **2단계: Google Apps Script 설정**

### 2-1. Apps Script 열기
1. 스프레드시트 상단 메뉴에서 **"확장 프로그램"** 클릭
2. **"Apps Script"** 클릭
3. 새 탭에서 Google Apps Script 편집기가 열림

### 2-2. 스크립트 코드 입력
기본으로 있는 `Code.gs` 파일의 내용을 모두 지우고, 아래 코드를 복사해서 붙여넣으세요:

\`\`\`javascript
function doPost(e) {
  try {
    // 현재 활성 시트 가져오기
    const sheet = SpreadsheetApp.getActiveSheet();
    
    // POST로 전송된 데이터 파싱
    const data = JSON.parse(e.postData.contents);
    
    console.log('받은 데이터:', data);
    
    // 다음 빈 행 번호 찾기
    const lastRow = sheet.getLastRow();
    const nextRow = lastRow + 1;
    
    // 한국 시간으로 변환
    const timestamp = new Date(data.timestamp);
    const koreanTime = Utilities.formatDate(timestamp, "Asia/Seoul", "yyyy-MM-dd HH:mm:ss");
    
    // 스프레드시트에 데이터 추가
    sheet.getRange(nextRow, 1).setValue(nextRow - 1); // ID (행번호-1)
    sheet.getRange(nextRow, 2).setValue(data.name || '');
    sheet.getRange(nextRow, 3).setValue(data.phone || '');
    sheet.getRange(nextRow, 4).setValue(data.company || '');
    sheet.getRange(nextRow, 5).setValue(data.message || '');
    sheet.getRange(nextRow, 6).setValue(koreanTime);
    
    console.log('데이터 저장 완료. 행:', nextRow);
    
    // 성공 응답
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true, 
        row: nextRow,
        message: '데이터가 성공적으로 저장되었습니다.'
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    console.error('오류 발생:', error);
    
    // 오류 응답
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false, 
        error: error.toString(),
        message: '데이터 저장 중 오류가 발생했습니다.'
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// 테스트용 함수 (선택사항)
function testDoPost() {
  const testData = {
    postData: {
      contents: JSON.stringify({
        name: "홍길동",
        phone: "010-1234-5678", 
        company: "테스트 회사",
        message: "구글 스프레드시트 연동 테스트입니다.",
        timestamp: new Date().toISOString()
      })
    }
  };
  
  const result = doPost(testData);
  console.log('테스트 결과:', result.getContent());
}
\`\`\`

### 2-3. 코드 저장
1. **Ctrl+S** (또는 Cmd+S)를 눌러 저장
2. 프로젝트 이름을 **"실버케어 마케팅 연동"**으로 설정

---

## 🚀 **3단계: 웹앱 배포**

### 3-1. 배포 시작
1. 우상단의 **"배포"** 버튼 클릭
2. **"새 배포"** 선택

### 3-2. 배포 설정
1. **유형 선택**: "웹앱" 클릭
2. **설명**: "실버케어 마케팅 상담신청 연동" 입력
3. **실행 계정**: "나" 선택 (중요!)
4. **액세스 권한**: **"모든 사용자"** 선택 (매우 중요!)

> ⚠️ **중요**: 액세스 권한을 반드시 "모든 사용자"로 설정해야 웹사이트에서 접근할 수 있습니다.

### 3-3. 권한 승인
1. **"배포"** 버튼 클릭
2. 권한 승인 팝업이 뜨면:
   - **"권한 검토"** 클릭
   - 본인 Google 계정 선택
   - **"고급"** → **"안전하지 않은 페이지로 이동"** 클릭
   - **"허용"** 클릭

### 3-4. 웹앱 URL 복사
배포 완료 후 나타나는 **웹앱 URL**을 복사하세요.
```
예시: https://script.google.com/macros/s/AKfycbx1234567890abcdef/exec
```

---

## 🔧 **4단계: 웹사이트 환경 설정**

### 4-1. 로컬 개발 환경 설정
프로젝트 폴더의 `.dev.vars` 파일을 편집하세요:

\`\`\`bash
# 구글 스프레드시트 연동을 위한 환경 변수
GOOGLE_SHEETS_URL=https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec
\`\`\`

> 💡 **YOUR_SCRIPT_ID** 부분을 복사한 실제 URL로 교체하세요.

### 4-2. 프로덕션 환경 설정 (배포시)
Cloudflare Pages에 배포할 때는 다음 명령어로 환경변수를 설정하세요:

\`\`\`bash
npx wrangler pages secret put GOOGLE_SHEETS_URL --project-name webapp
# 프롬프트에서 구글 스프레드시트 URL 입력
\`\`\`

---

## 🧪 **5단계: 테스트 및 확인**

### 5-1. Google Apps Script 테스트
1. Apps Script 편집기에서 **"testDoPost"** 함수 선택
2. **"실행"** 버튼 클릭  
3. 스프레드시트에 테스트 데이터가 추가되는지 확인

### 5-2. 웹사이트 연동 테스트
1. 웹사이트 서버 재시작:
   \`\`\`bash
   cd /home/user/webapp
   fuser -k 3000/tcp 2>/dev/null || true
   npm run build
   pm2 start ecosystem.config.cjs
   \`\`\`

2. 관리자 페이지에서 **"테스트 데이터 추가"** 버튼 클릭
3. 스프레드시트에 실시간으로 데이터가 추가되는지 확인

### 5-3. 실제 상담신청 테스트
1. 메인 페이지의 상담신청 폼 작성
2. "상담 신청하기" 버튼 클릭
3. 구글 스프레드시트와 관리자 페이지 모두에서 데이터 확인

---

## 📊 **6단계: 스프레드시트 공유 및 활용**

### 6-1. 스프레드시트 공유
1. 스프레드시트 우상단 **"공유"** 버튼 클릭
2. 팀원들의 이메일 주소 추가
3. 권한 설정: "편집자" 또는 "뷰어" 선택

### 6-2. 자동화 기능 추가 (선택사항)
- **필터 설정**: 데이터 정렬 및 필터링
- **조건부 서식**: 신규 신청 강조 표시
- **차트 생성**: 상담신청 통계 시각화
- **알림 설정**: 새 신청시 이메일 알림

---

## 🔍 **문제해결 가이드**

### ❌ **자주 발생하는 오류**

**1. "권한이 거부되었습니다" 오류**
- **해결**: 웹앱 배포시 액세스 권한을 "모든 사용자"로 설정

**2. "스크립트를 찾을 수 없습니다" 오류**  
- **해결**: 웹앱 URL이 정확한지 확인, 새로 배포 후 URL 재복사

**3. "데이터가 저장되지 않습니다"**
- **해결**: Apps Script의 testDoPost 함수로 먼저 테스트
- 실행 로그 확인 (Apps Script 편집기 → 실행 → 로그 보기)

**4. "CORS 오류"**
- **해결**: 웹앱이 올바르게 배포되었는지 확인
- 브라우저 개발자 도구 Network 탭에서 응답 확인

### ✅ **성공 확인 방법**

1. **Apps Script 로그**: 실행 → 로그에서 "데이터 저장 완료" 메시지 확인
2. **스프레드시트**: 새 행에 데이터가 실시간 추가되는지 확인  
3. **관리자 페이지**: `/admin/contacts`에서 동시에 데이터 확인
4. **브라우저 콘솔**: F12 → Console에서 오류 메시지 없는지 확인

---

## 💡 **추가 팁**

### 📱 **모바일에서도 확인 가능**
- 구글 스프레드시트 앱에서도 실시간 확인 가능
- 외출 중에도 상담신청 현황 모니터링 가능

### 📈 **데이터 분석 활용**  
- 월별/일별 상담신청 추이 분석
- 회사명 기준 B2B vs B2C 분류
- 상담 전환율 계산

### 🔒 **보안 고려사항**
- 스프레드시트 공유시 적절한 권한 설정
- 개인정보 처리방침 준수
- 정기적인 데이터 백업 권장

---

## 🎯 **완료 체크리스트**

- [ ] 구글 스프레드시트 생성 및 헤더 설정
- [ ] Google Apps Script 코드 입력
- [ ] 웹앱 배포 및 권한 설정 
- [ ] 웹앱 URL 복사
- [ ] .dev.vars 파일에 URL 설정
- [ ] 서버 재시작  
- [ ] testDoPost 함수 실행 테스트
- [ ] 관리자 페이지에서 테스트 데이터 추가
- [ ] 실제 상담신청 폼 테스트
- [ ] 스프레드시트에 데이터 실시간 추가 확인

모든 단계를 완료하면 상담신청이 **자동으로 구글 스프레드시트에 실시간 저장**됩니다! 🎉